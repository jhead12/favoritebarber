# Yelp API Audit

Generated by `scripts/yelp_audit.js` — lists files referencing "yelp" and sample lines.

## api/README.md

- L24: - `YELP_API_KEY` — Yelp API access token
- L28: - `USE_YELP_GRAPHQL` — Toggle GraphQL enrichment path

## api/ai/prompts/review_name_extraction.md

- L8: You are given a single Yelp review text. Return a JSON array of candidate barber names mentioned in the review. If none, return an empty array.

## api/index.js

- L9: const { queryYelpGraphql } = require('./yelp_graphql');
- L10: const { mapRestBusiness, mapGraphqlBusiness } = require('./lib/yelp_normalize');
- L11: const { acquireYelpToken } = require('./lib/mcpRateLimiter');
- L30: // Breaker for Yelp outbound calls
- L31: const yelpBreaker = new CircuitBreaker({ failureThreshold: 5, successThreshold: 2, timeoutMs: Number(process.env.YELP_BREAKER_TIMEOUT_MS || 10000), resetMs: Number(process.env.YELP_BREAKER_RESET_MS || 30000) });
- L32: const YELP_API_KEY = process.env.YELP_API_KEY;
- L71: // Lightweight Yelp proxy for search (term + location)
- L72: // Example: /api/yelp-search?term=fade&location=San%20Francisco
- L73: app.get('/api/yelp-search', async (req, res) => {
- L74: if (!YELP_API_KEY) {

## api/jobs/scoreRecomputation.js

- L82: * Recompute barber score - aggregates from user reviews and Yelp data
- L95: -- Include any existing aggregated Yelp data so it can influence the trust score
- L96: COALESCE(bs.yelp_rating, 0) as yelp_rating,
- L97: COALESCE(bs.yelp_review_count, 0) as yelp_review_count
- L103: GROUP BY b.id, bs.yelp_rating, bs.yelp_review_count
- L117: -- trust_score mixes our users' ratings with external Yelp signals.
- L118: -- Give substantial weight to Yelp star rating, and a capped logarithmic
- L119: -- boost for Yelp review counts so well-reviewed shops give extra points.
- L122: -- Yelp star rating contributes similarly to user avg (scale 0-5 -> 0-100 via *20)
- L123: yelp_rating * 20 +

## api/lib/mcpRateLimiter.js

- L7: // Redis-backed combined Yelp quota helper key prefix
- L8: const YELP_QUOTA_KEY_PREFIX = process.env.YELP_QUOTA_KEY_PREFIX || 'yelp_quota';
- L9: const YELP_DAILY_QUOTA = Number(process.env.YELP_DAILY_QUOTA || 5000);
- L58: function yelpKeyForDate(accountId = 'default') {
- L61: return `${YELP_QUOTA_KEY_PREFIX}:${accountId}:${day}`;
- L64: async function acquireYelpToken(opts = {}) {
- L68: const quota = Number(process.env.YELP_DAILY_QUOTA || YELP_DAILY_QUOTA);
- L71: const key = yelpKeyForDate(accountId);
- L76: const b = getBucket(`yelp_fallback:${accountId}`);
- L79: const r = consumeToken(`yelp_fallback:${accountId}`);

## api/lib/yelp_normalize.js

- L2: * Normalize Yelp REST and GraphQL responses into a canonical business shape
- L24: yelp_url: b.url || b.yelp_url || null,
- L46: yelp_url: b.url || null,

## api/middleware/mcpAuth.js

- L3: // Example: export MCP_API_KEYS='{"key1":{"partnerId":"acme","scopes":["read:bars","read:live_yelp"]}}'
- L20: keys['dev'] = { partnerId: 'local-dev', scopes: ['read:bars', 'read:live_yelp'] };

## api/models/user.js

- L317: yelp_stats AS (
- L319: AVG(CAST(rating AS NUMERIC)) as yelp_avg_rating,
- L320: COUNT(*) as yelp_count,
- L325: INSERT INTO barber_scores (barber_id, user_rating_avg, user_review_count, would_return_percentage, yelp_rating, yelp_review_count, yelp_sentiment_avg, recent_reviews_count, trust_score, computed_at)
- L331: ys.yelp_avg_rating,
- L332: ys.yelp_count,
- L339: CROSS JOIN yelp_stats ys
- L344: yelp_rating = EXCLUDED.yelp_rating,
- L345: yelp_review_count = EXCLUDED.yelp_review_count,
- L346: yelp_sentiment_avg = EXCLUDED.yelp_sentiment_avg,

## api/routes/barbers.js

- L9: // Support lookup by numeric internal id or by external Yelp business id
- L15: WHERE ${isNumeric ? 'b.id = $1' : 'b.yelp_business_id = $1'} LIMIT 1`,
- L22: // When we looked up by Yelp id, ensure we use the internal barber id to join shop_barbers
- L100: const yelpId = b.yelp_business_id || null;
- L101: if (yelpId) {
- L105: WHERE (evidence->> 'yelp_business') = $1
- L106: OR (evidence->'source_record'->> 'yelp_business') = $1
- L109: [String(yelpId)]

## api/routes/mcp.js

- L49: // Feature-flagged live Yelp proxy (stub)
- L50: router.get('/live_yelp/:id', (req, res) => {
- L51: const enabled = process.env.MCP_ENABLE_LIVE_YELP === 'true';
- L52: if (!enabled) return res.status(403).json({ error: 'live_yelp_disabled' });
- L53: // For now respond with a placeholder — implementation should call the Yelp GraphQL client
- L54: res.json({ message: 'live_yelp proxy stub', id: req.params.id, partner: req.mcp && req.mcp.partnerId });

## api/routes/search.js

- L2: // Query params supported: query (shop name), location (text), yelp_id
- L9: // POST /api/search  { query, location, yelp_id }
- L12: const { query, location, yelp_id } = req.body || {};
- L13: if (!query && !yelp_id) return res.status(400).json({ error: 'query_or_yelp_id_required' });
- L25: `INSERT INTO discovery_jobs (shop_name, location_text, yelp_business_id, search_query_id, status, created_at, updated_at) VALUES ($1,$2,$3,$4,'pending', now(), now()) RETURNING *`,
- L26: [query || null, location || null, yelp_id || null, sq.rows[0].id]

## api/routes/shops.js

- L9: // Accept either numeric DB id or Yelp business id (string). If id is not an integer, try yelp_business_id lookup.
- L14: q = await pool.query('SELECT * FROM shops WHERE yelp_business_id = $1 LIMIT 1', [id]);
- L22: yelp_business_id: s.yelp_business_id,

## api/scripts/seed_sample_shop.js

- L16: `INSERT INTO shops (name, yelp_business_id, primary_location_id, trust_score) VALUES ($1,$2,$3,$4) RETURNING id`,

## api/scripts/validate_yelp_graphql.js

- L3: const { queryYelpGraphql } = require('../yelp_graphql');
- L6: if (!process.env.YELP_API_KEY) {
- L7: console.log('YELP_API_KEY is not set. To validate GraphQL, set YELP_API_KEY in your environment.');
- L8: console.log('Example: YELP_API_KEY=your_key node api/scripts/validate_yelp_graphql.js <business_id>');
- L11: const businessId = process.argv[2] || process.env.YELP_SAMPLE_BUSINESS_ID;
- L13: console.error('Provide a business id as the first arg or set YELP_SAMPLE_BUSINESS_ID');
- L28: const res = await queryYelpGraphql(query, { cost: 1 });

## api/seed_images.js

- L8: { url: 'https://s3.example.com/uploads/barber-shop-1.jpg', source: 'yelp', source_id: 'sample-img-1' },

## api/startup.js

- L9: if (!process.env.YELP_API_KEY || !process.env.DATABASE_URL) {

## api/test_yelp_graphql.js

- L1: const { queryYelpGraphql } = require('./yelp_graphql');
- L5: if (!process.env.YELP_API_KEY) {
- L6: console.error('YELP_API_KEY not set. Set it and re-run. Example:');
- L7: console.error("export YELP_API_KEY=\"YOUR_TOKEN_HERE\"");
- L9: console.error("curl -X POST -H \"Authorization: Bearer ACCESS_TOKEN\" -H \"Content-Type: application/graphql\" https://api.yelp.com/v3/graphql --data '\\n{\n    business(id: \"garaje-san-francisco\") {\n        name\n        id\n        alias\n        rating\n        url\n    }\n}'");
- L26: const resp = await queryYelpGraphql(query);

## api/yelp_graphql.js

- L3: const { acquireYelpToken } = require('./lib/mcpRateLimiter');
- L8: // Breaker instance for Yelp outbound calls
- L9: const yelpBreaker = new CircuitBreaker({ failureThreshold: 5, successThreshold: 2, timeoutMs: Number(process.env.YELP_BREAKER_TIMEOUT_MS || 10000), resetMs: Number(process.env.YELP_BREAKER_RESET_MS || 30000) });
- L11: const YELP_GRAPHQL_URL = 'https://api.yelp.com/v3/graphql';
- L12: const API_KEY = process.env.YELP_API_KEY || process.env.YELP_API_KEY_TOKEN;
- L13: const DEFAULT_TIMEOUT_MS = Number(process.env.YELP_GRAPHQL_TIMEOUT_MS || 8000);
- L14: const DEFAULT_RETRIES = Number(process.env.YELP_GRAPHQL_RETRIES || 2);
- L28: async function queryYelpGraphql(queryString, opts = {}) {
- L30: throw new Error('Missing YELP_API_KEY environment variable. Export YELP_API_KEY and retry.');
- L41: // Acquire combined Yelp quota (REST + GraphQL) before making the outbound call.

## api/yelp_probe.js

- L1: // Simple Yelp probe to inspect data fields we can collect
- L2: // Usage: set YELP_API_KEY in env (we read from process.env)
- L4: const API_BASE = 'https://api.yelp.com/v3';
- L8: if (!process.env.YELP_API_KEY) {
- L28: const key = process.env.YELP_API_KEY;
- L29: if (!key) throw new Error('YELP_API_KEY not set in env');
- L35: throw new Error(`Yelp API ${res.status} ${res.statusText}: ${txt}`);
- L52: console.log('Searching Yelp for `barbers` near San Francisco, CA...');

## workers/barber_reconciler.js

- L33: async function findBarberByYelpId(yelpId) {
- L34: if (!yelpId) return null;
- L35: const q = `SELECT id, name FROM barbers WHERE yelp_business_id = $1 LIMIT 1`;
- L36: const r = await pool.query(q, [String(yelpId)]);
- L87: // check for explicit yelp_business evidence
- L88: const yelpBusiness = (evidence && (evidence.yelp_business || (evidence.source_record && evidence.source_record.yelp_business))) || null;
- L92: if (yelpBusiness) {
- L93: barber = await findBarberByYelpId(String(yelpBusiness));
- L94: heur.byYelp = !!barber;

## workers/crawlers/shop_barber_discoverer.js

- L11: const q = `SELECT s.id, s.name, s.yelp_business_id, l.formatted_address, l.city, l.region

## workers/crawlers/yelp_fetcher.js

- L2: // Yelp fetcher implementation (Node)
- L15: if (process.env.YELP_API_KEY) return;
- L31: async function yelpApi(path) {
- L33: const key = process.env.YELP_API_KEY;
- L34: if (!key) throw new Error('YELP_API_KEY not set in env. Get your key from https://www.yelp.com/developers');
- L35: const res = await fetch(`https://api.yelp.com/v3${path}`, {
- L40: throw new Error(`Yelp API ${res.status} ${res.statusText}: ${txt}`);
- L49: const res = await client.query('SELECT id FROM barbers WHERE yelp_business_id = $1', [business.id]);
- L58: const insert = await client.query('INSERT INTO barbers (name, yelp_business_id, metadata) VALUES ($1,$2,$3) RETURNING id', [business.name, business.id, metadata]);
- L72: // upsert into shops table using yelp_business_id

## workers/crawlers/yelp_fetcher.ts

- L1: // Yelp fetcher implementation (Node)
- L14: if (process.env.YELP_API_KEY) return;
- L30: async function yelpApi(path) {
- L32: const key = process.env.YELP_API_KEY;
- L33: if (!key) throw new Error('YELP_API_KEY not set in env');
- L34: const res = await fetch(`https://api.yelp.com/v3${path}`, {
- L39: throw new Error(`Yelp API ${res.status} ${res.statusText}: ${txt}`);
- L48: const res = await client.query('SELECT id FROM barbers WHERE yelp_business_id = $1', [business.id]);
- L57: const insert = await client.query('INSERT INTO barbers (name, yelp_business_id, metadata) VALUES ($1,$2,$3) RETURNING id', [business.name, business.id, metadata]);
- L71: // upsert into shops table using yelp_business_id

## workers/crawlers/yelp_to_socials.js

- L2: // Find social links from a Yelp business page, then visit the business website(s)
- L17: const SNAPSHOT_DIR = process.env.RYB_SNAPSHOT_DIR || path.join(os.tmpdir(), 'ryb-yelp-snapshots');
- L21: const YELP_KEY = process.env.YELP_API_KEY || null;
- L23: async function yelpSearchByName(name, location) {
- L24: if (!YELP_KEY) throw new Error('YELP_API_KEY not set in env');
- L25: const res = await fetch(`https://api.yelp.com/v3/businesses/search?term=${encodeURIComponent(name)}&location=${encodeURIComponent(location || '')}&limit=3`, { headers: { Authorization: `Bearer ${YELP_KEY}` } });
- L26: if (!res.ok) throw new Error(`Yelp search failed ${res.status}`);
- L30: async function yelpGetBusiness(id) {
- L31: if (!YELP_KEY) throw new Error('YELP_API_KEY not set in env');
- L32: const res = await fetch(`https://api.yelp.com/v3/businesses/${encodeURIComponent(id)}`, { headers: { Authorization: `Bearer ${YELP_KEY}` } });

## workers/discovery_daemon.js

- L2: // Poll discovery_jobs table and process pending jobs by calling yelp_to_socials
- L5: const { run: yelpToSocialsRun } = require('./crawlers/yelp_to_socials');
- L25: console.log('Processing discovery job', job.id, job.shop_name || job.yelp_business_id);
- L28: // call yelp_to_socials.run with appropriate params
- L29: const out = await yelpToSocialsRun({ yelpId: job.yelp_business_id || null, name: job.shop_name || null, location: job.location_text || null, dryRun: false });

## workers/image_processor.js

- L58: const analysis = { provenance_score: source === 'yelp' ? 0.25 : 0.05, objects: {}, faces: { count: 0, score: 0 }, ocr: { text: null, score: 0 }, p_hash: `phash-${Math.random().toString(36).slice(2,9)}` };
- L112: provenance_score: image.source === 'yelp' ? 0.25 : 0.05,
- L200: { id: 'img1', url: 'https://s3.example.com/uploads/barber-shop-1.jpg', source: 'yelp' },

## workers/image_processor_stub.js

- L7: { id: 'img1', url: 'https://s3.example.com/uploads/barber-shop-1.jpg', source: 'yelp' },
- L9: { id: 'img3', url: 'https://images.yelp.com/photo-abc123.jpg', source: 'yelp' }
- L16: provenance_score: image.source === 'yelp' ? 0.25 : 0.05,

## workers/llm/TESTS_README.md

- L16: - End-to-end workflow helper for fetching from Yelp (requires Yelp API key / TypeScript runner), processing images, and summarizing results.
- L23: - For fetching from Yelp: set `YELP_API_KEY` in environment or root `.env` file.
- L25: - To run TypeScript fetcher directly: install `ts-node` (optional) or compile `workers/crawlers/yelp_fetcher.ts` to JavaScript.
- L50: Note on dates: Reviews ingested from sources (like Yelp) will have their original post timestamp stored in `reviews.created_at` when available; otherwise the ingestion sets a fallback timestamp. Tests that rely on age/scoring should ensure `created_at` is present or set synthetic timestamps in fixtures.
- L60: 4) End-to-end fetch from Yelp (requires `YELP_API_KEY` and either compiling the TypeScript fetcher or running it with `ts-node`):
- L64: node -r ts-node/register workers/crawlers/yelp_fetcher.ts "San Francisco, CA"
- L66: # Or use the simple probe (JS) to inspect Yelp fields
- L67: YELP_API_KEY=your_key node api/yelp_probe.js

## workers/test_e2e_hairstyle_workflow.js

- L6: 1. Fetch barber businesses from Yelp API (gets photos)
- L15: # Fetch from Yelp and process:
- L27: async function step1_fetchFromYelp(location, limit = 3) {
- L29: console.log('STEP 1: FETCH BUSINESSES FROM YELP');
- L34: console.log('NOTE: To fetch from Yelp, run:');
- L35: console.log(`  node workers/crawlers/yelp_fetcher.ts "${location}"`);
- L39: console.log(`  YELP_API_KEY=your_key node api/yelp_probe.js\n`);
- L47: b.yelp_business_id,
- L51: WHERE b.yelp_business_id IS NOT NULL
- L57: console.log('Current barbers with Yelp images:');

## workers/test_yelp_llm_integration.js

- L4: - Calls Yelp Business Search for `barbers` in the given location
- L10: YELP_API_KEY=your_key node workers/test_yelp_llm_integration.js "San Francisco, CA"
- L12: If YELP_API_KEY is not set, the script will exit with an error.
- L19: const API_BASE = 'https://api.yelp.com/v3';
- L22: const key = process.env.YELP_API_KEY;
- L24: console.error('YELP_API_KEY not set. Set it in environment or .env file.');
- L30: async function yelpApi(path) {
- L35: throw new Error(`Yelp API ${res.status} ${res.statusText}: ${txt}`);
- L41: console.log('Searching Yelp for `barbers` near:', location);
- L42: const search = await yelpApi(`/businesses/search?term=barbers&location=${encodeURIComponent(location)}&limit=3`);

## scripts/yelp_audit.js

- L50: lines.push('# Yelp API Audit');
- L52: lines.push('Generated by `scripts/yelp_audit.js` — lists files referencing "yelp" and sample lines.');
- L67: const results = searchFiles(targets, 'yelp');
- L71: const outPath = path.join(outDir, 'YELP_AUDIT.md');
